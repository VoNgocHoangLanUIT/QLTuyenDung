
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
        xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{user/layout/head :: head}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/> 
</head>

<body>

  <div class="page-wrapper dashboard ">

    <!-- Preloader -->
    <div class="preloader"></div>

    <!-- Header Span -->
    <span class="header-span"></span>

    <!-- Main Header-->
    <header th:replace="~{user/layout/header :: header}"></header>
    <!--End Main Header -->

    <!-- Sidebar Backdrop -->
    <div class="sidebar-backdrop"></div>

    <!-- User Sidebar -->
    <div th:replace="~{ungvien/layout/sidebar :: sidebar}"></div>
    <!-- End User Sidebar -->

    <!-- Dashboard -->
    <section class="user-dashboard">
      <div class="dashboard-outer">
        <div class="upper-title-box">
          <h3>Thông tin cá nhân!</h3>
        </div>
        
        <div class="alert alert-success" th:if="${success}" th:text="${success}"></div>
        <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>

        <div class="row">
          <div class="col-lg-12">
            <!-- Ls widget -->
            <div class="ls-widget">
                <div class="tabs-box">
                    <div class="widget-title">
                        <h4>Thông tin cơ bản</h4>
                    </div>
                    <div class="widget-content">
                        <form class="default-form" method="post" th:action="@{/ungvien/edit-user}" enctype="multipart/form-data" th:object="${user}">
                            <div class="uploading-outer">
                                <div class="uploadButton">
                                    <input class="uploadButton-input" type="file" name="avatarFile" accept="image/*" id="upload" />
                                    <label class="uploadButton-button ripple-effect" for="upload">Chọn avatar</label>
                                    <span class="uploadButton-file-name"></span>
                                </div>
                                <div class="text">Dung lượng tối đa 1MB, kích thước tối thiểu: 330x300, định dạng .jpg & .png</div>
                                <div th:if="${user != null && user.hinhAnh != null}" class="mt-3">
                                    <p>Avatar hiện tại:</p>
                                    <img th:src="@{'/fe/images/resource/avatar/' + ${user.hinhAnh}}" alt="Avatar hiện tại" style="max-width: 200px; max-height: 150px;">
                                </div>
                            </div>

                            <div class="row">
                            <!-- Họ tên -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Họ tên <span class="required">*</span></label>
                                    <input type="text" th:field="*{hoTen}" name="hoTen" required placeholder="Nhập họ tên">
                                </div>

                            <!-- Email -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Email</label>
                                    <input type="email" th:field="*{email}" name="email" readonly>
                                </div>

                            <!-- Số điện thoại -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Số điện thoại</label>
                                    <input type="text" th:field="*{soDienThoai}" name="soDienThoai" placeholder="Nhập số điện thoại">
                                </div>
                            <!-- Giới tính -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Giới tính</label>
                                    <select class="chosen-select" th:field="*{gioiTinh}" name="gioiTinh">
                                        <option value="">-- Chọn giới tính --</option>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                        <option value="Khác">Khác</option>
                                    </select>
                                </div>
                            <!-- Tuổi -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Tuổi</label>
                                    <input type="number" th:field="*{tuoi}" name="tuoi" min="0" placeholder="Nhập tuổi">
                                </div>
                            <!-- Chuyên ngành -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Chuyên ngành</label>
                                    <input type="text" th:field="*{chuyenNganh}" name="chuyenNganh" placeholder="Nhập chuyên ngành">
                                </div>

                            <!-- Số năm kinh nghiệm -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Số năm kinh nghiệm</label>
                                    <input type="number" th:field="*{namKinhNghiem}" name="namKinhNghiem" min="0" placeholder="Nhập số năm kinh nghiệm">
                                </div>

                            <!-- Lương mong muốn -->
                                <div class="form-group col-lg-6 col-md-12">
                                    <label>Lương mong muốn</label>
                                    <input type="number" th:field="*{luongMongMuon}" name="luongMongMuon" min="0" placeholder="Nhập lương mong muốn">
                                </div>

                                <!-- Các ngôn ngữ -->
                                <div class="form-group col-lg-12 col-md-12">
                                    <label>Các ngôn ngữ</label>
                                    <input type="text" th:field="*{ngonNgu}" name="ngonNgu" placeholder="Nhập các ngôn ngữ (VD: Tiếng Anh, Tiếng Nhật)">
                                </div>


                            <!-- Giới thiệu bản thân -->
                                <div class="form-group col-lg-12 col-md-12">
                                    <label>Giới thiệu bản thân</label>
                                    <textarea th:field="*{gioiThieu}" name="gioiThieu" placeholder="Giới thiệu về bản thân"></textarea>
                                </div>
                                <div class="form-group col-lg-12 col-md-12">
                                    <button type="submit" class="theme-btn btn-style-one">Lưu</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="ls-widget">
              <div class="tabs-box">
                <div class="widget-title">
                  <h4>Thông tin ứng viên</h4>
                </div>

                <div class="widget-content">
                    <div class="row">
                      <!-- Input -->
                      <div class="form-group col-lg-12 col-md-12">
                        <label>Upload CV của bạn</label>
                      </div>
                    </div>
                    <form class="default-form cv-upload-form" method="post" th:action="@{/ungvien/upload-cv}" enctype="multipart/form-data">
                        <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="uploading-outer">
                        <div class="uploadButton">
                            <input class="uploadButton-input" type="file" name="cvMultipartFile" accept=".pdf,.doc,.docx" id="upload-cv" />
                            <label class="uploadButton-button ripple-effect" for="upload-cv">Chọn file CV</label>
                            <span class="uploadButton-file-name"></span>
                        </div>
                        <div class="text">Dung lượng tối đa 5MB, định dạng .pdf, .doc, .docx</div>
                            <div th:if="${user != null && user.cvFile != null}" class="mt-3">
                            <p>CV hiện tại: <span th:text="${user.cvFile}"></span></p>
                            <div class="btn-group">
                                <a th:href="@{'/download-cv/' + ${user.id}}" class="theme-btn btn-style-three" target="_blank">
                                    <span class="icon-text"><span class="la la-download"></span> Xem CV</span>
                                </a>
                                <button type="button" id="delete-cv" class="theme-btn btn-style-three btn-danger">
                                    <span class="icon-text"><span class="la la-trash"></span> Xóa CV</span>
                                </button>
                            </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="theme-btn btn-style-one">Tải CV lên</button>
                        </div>
                    </form>

                    <div class="row">
                      <div class="form-group col-lg-12 col-md-12">
                        <!-- Resume / Education -->
                        <div class="resume-outer">
                            <div class="upper-title">
                                <h4>Học vấn</h4>
                                <a th:href="@{/ungvien/add-hocvan}" class="add-info-btn"><span class="icon flaticon-plus"></span> Thêm học vấn</a>
                            </div>
                            
                            <!-- Hiển thị các mục học vấn nếu có -->
                            <div th:if="${dSHocVan != null && !dSHocVan.isEmpty()}">
                                <!-- Resume BLock -->
                                <div class="resume-block" th:each="hocVan : ${dSHocVan}">
                                    <div class="inner">
                                        <span class="name" th:text="${hocVan.tenDVCap != null && !hocVan.tenDVCap.isEmpty()} ? ${#strings.substring(hocVan.tenDVCap, 0, 1)} : 'E'"></span>
                                        <div class="title-box">
                                            <div class="info-box">
                                                <h3 th:text="${hocVan.tenBang}">Tên bằng cấp</h3>
                                                <span th:text="${hocVan.tenDVCap}">Đơn vị cấp</span>
                                            </div>
                                            <div class="edit-box">
                                                <span class="year" th:text="${hocVan.namBD} + ' - ' + ${hocVan.namKT}">Năm</span>
                                                <div class="edit-btns">
                                                    <a th:href="@{'/ungvien/edit-hocvan/' + ${hocVan.id}}"><span class="la la-pencil"></span></a>
                                                    <a th:href="@{'/ungvien/delete-hocvan/' + ${hocVan.id}}" class="delete-btn"><span class="la la-trash"></span></a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text" th:text="${hocVan.moTa}">Mô tả</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hiển thị thông báo nếu chưa có thông tin học vấn -->
                            <div th:if="${dSHocVan == null || dSHocVan.isEmpty()}" class="resume-block">
                                <div class="inner text-center">
                                <p>Bạn chưa có thông tin học vấn nào. Hãy thêm học vấn để hoàn thiện hồ sơ của mình.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Resume / Work & Experience -->
                        <div class="resume-outer theme-blue">
                            <div class="upper-title">
                                <h4>Kinh nghiệm làm việc</h4>
                                <a th:href="@{/ungvien/add-kinhnghiem}" class="add-info-btn"><span class="icon flaticon-plus"></span> Thêm kinh nghiệm</a>
                            </div>
                            
                            <!-- Hiển thị các mục kinh nghiệm làm việc nếu có -->
                            <div th:if="${dSKinhNghiem != null && !dSKinhNghiem.isEmpty()}">
                                <!-- Resume BLock -->
                              <div class="resume-block" th:each="kinhNghiem : ${dSKinhNghiem}">
                                <div class="inner">
                                  <span class="name" th:text="${kinhNghiem.tenCongTy != null && !kinhNghiem.tenCongTy.isEmpty()} ? ${#strings.substring(kinhNghiem.tenCongTy, 0, 1)} : 'C'"></span>
                                  <div class="title-box">
                                    <div class="info-box">
                                        <h3 th:text="${kinhNghiem.viTriCongViec}">Vị trí công việc</h3>
                                        <span th:text="${kinhNghiem.tenCongTy}">Tên công ty</span>
                                    </div>
                                    <div class="edit-box">
                                        <span class="year" th:text="${kinhNghiem.namBD} + ' - ' + ${kinhNghiem.namKT}">Năm</span>
                                        <div class="edit-btns">
                                        <a th:href="@{'/ungvien/edit-kinhnghiem/' + ${kinhNghiem.id}}"><span class="la la-pencil"></span></a>
                                        <a th:href="@{'/ungvien/delete-kinhnghiem/' + ${kinhNghiem.id}}" class="delete-btn"><span class="la la-trash"></span></a>
                                        </div>
                                    </div>
                                  </div>
                                  <div class="text" th:text="${kinhNghiem.moTa}">Mô tả</div>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Hiển thị thông báo nếu chưa có thông tin kinh nghiệm -->
                            <div th:if="${dSKinhNghiem == null || dSKinhNghiem.isEmpty()}" class="resume-block">
                                <div class="inner text-center">
                                <p>Bạn chưa có thông tin kinh nghiệm làm việc nào. Hãy thêm kinh nghiệm để hoàn thiện hồ sơ của mình.</p>
                                </div>
                            </div>
                        </div>
                      </div>

                      <div class="form-group col-lg-12 col-md-12">
                        <!-- Resume / Awards -->
                        <div class="resume-outer theme-yellow">
                            <div class="upper-title">
                                <h4>Thành tựu</h4>
                                <a th:href="@{/ungvien/add-thanhtuu}" class="add-info-btn"><span class="icon flaticon-plus"></span> Thêm thành tựu</a>
                            </div>
                            
                            <!-- Hiển thị các mục thành tựu nếu có -->
                            <div th:if="${dSThanhTuu != null && !dSThanhTuu.isEmpty()}">
                                <!-- Resume BLock -->
                              <div class="resume-block" th:each="thanhTuu : ${dSThanhTuu}">
                                <div class="inner">
                                    <span class="name">A</span>
                                  <div class="title-box">
                                    <div class="info-box">
                                        <h3 th:text="${thanhTuu.tenThanhTuu}">Tên thành tựu</h3>
                                        <span></span>
                                    </div>
                                    <div class="edit-box">
                                        <span class="year" th:text="${#dates.format(thanhTuu.ngayDat, 'dd/MM/yyyy')}">Ngày đạt</span>
                                        <div class="edit-btns">
                                        <a th:href="@{'/ungvien/edit-thanhtuu/' + ${thanhTuu.id}}"><span class="la la-pencil"></span></a>
                                        <a th:href="@{'/ungvien/delete-thanhtuu/' + ${thanhTuu.id}}" class="delete-btn"><span class="la la-trash"></span></a>
                                        </div>
                                    </div>
                                  </div>
                                  <div class="text" th:text="${thanhTuu.moTa}">Mô tả</div>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Hiển thị thông báo nếu chưa có thành tựu -->
                            <div th:if="${dSThanhTuu == null || dSThanhTuu.isEmpty()}" class="resume-block">
                                <div class="inner text-center">
                                <p>Bạn chưa có thông tin thành tựu nào. Hãy thêm thành tựu để hoàn thiện hồ sơ của mình.</p>
                                </div>
                            </div>
                        </div>
                      </div>
                    </div>
                </div>
              </div>
            </div>
          </div>

            <!-- Ls widget -->
            <div class="ls-widget">
              <div class="tabs-box">
                <div class="widget-title">
                  <h4>Mạng xã hội</h4>
                </div>

                <div class="widget-content">
                  <form class="default-form" method="post" th:action="@{/ungvien/edit-mxh}" th:object="${user}">
                    <div class="row">
                      <!-- Facebook -->
                      <div class="form-group col-lg-6 col-md-12">
                        <label>Facebook</label>
                        <input type="text" th:field="*{faceBook}" name="faceBook" placeholder="www.facebook.com/ten-user">
                      </div>

                      <!-- LinkedIn -->
                      <div class="form-group col-lg-6 col-md-12">
                        <label>LinkedIn</label>
                        <input type="text" th:field="*{linkedIn}" name="linkedIn" placeholder="www.linkedin.com/in/ten-user">
                      </div>

                      <!-- Nút lưu -->
                      <div class="form-group col-lg-12 col-md-12">
                        <button type="submit" class="theme-btn btn-style-one">Lưu</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Ls widget -->
            <div class="ls-widget">
              <div class="tabs-box">
                <div class="widget-title">
                  <h4>Địa chỉ</h4>
                </div>

                <div class="widget-content">
                    <form class="default-form" method="post" th:action="@{/ungvien/edit-diachi}" th:object="${user}">
                        <div class="row">
                            <div class="form-group col-lg-6 col-md-12">
                                <label>Địa chỉ</label>
                                <input type="text" th:field="*{diaChi}" name="diaChi" placeholder="Nhập địa chỉ của bạn">
                            </div>

                            <div class="form-group col-lg-12 col-md-12">
                                <button class="theme-btn btn-style-three">Search Location</button>
                            </div>


                            <div class="form-group col-lg-12 col-md-12">
                                <div class="map-outer">
                                    <div class="map-canvas map-height" data-zoom="12" data-lat="-37.817085" data-lng="144.955631" data-type="roadmap" data-hue="#ffc400" data-title="Envato" data-icon-path="images/resource/map-marker.png" data-content="Melbourne VIC 3000, Australia<br><a href='mailto:info@youremail.com'>info@youremail.com</a>">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group col-lg-12 col-md-12">
                                <button type="submit" class="theme-btn btn-style-one">Lưu</button>
                            </div>
                        </div>
                    </form>
                </div>
              </div>
            </div>

          </div>


        </div>
      </div>
    </section>
    <!-- End Dashboard -->

    <!-- Copyright -->
    <div th:replace="~{nhatuyendung/layout/footer :: footer}"></div>

  </div><!-- End Page Wrapper -->


  <div th:replace="~{user/layout/script :: script}"></div>
  <!--Google Map APi Key-->
  <script src="http://maps.google.com/maps/api/js?key=AIzaSyDaaCBm4FEmgKs5cfVrh3JYue3Chj1kJMw&amp;ver=5.2.4"></script>
  <script th:src="@{/fe/js/map-script.js}"></script>
  <!--End Google Map APi-->
  <!-- Thêm vào phần script ở cuối trang -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Hiển thị tên file khi chọn file
    document.getElementById('upload-cv').addEventListener('change', function() {
      var fileName = this.files[0].name;
      var fileNameDisplay = document.querySelector('.uploadButton-file-name');
      fileNameDisplay.textContent = fileName;
    });
    
    // Xử lý nút xóa CV
    var deleteBtn = document.getElementById('delete-cv');
    if (deleteBtn) {
    deleteBtn.addEventListener('click', function() {
        if (confirm('Bạn có chắc chắn muốn xóa CV hiện tại không?')) {
        // Gửi yêu cầu xóa CV mà không cần CSRF token
        fetch('/ungvien/delete-cv', {
            method: 'POST',
            credentials: 'same-origin' // Gửi cookies với request
        })
        .then(response => {
            if (response.ok) {
            location.reload();
            } else {
            response.text().then(text => {
                console.error('Lỗi:', text);
                alert('Đã xảy ra lỗi khi xóa CV');
            }).catch(() => {
                alert('Đã xảy ra lỗi khi xóa CV');
            });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Đã xảy ra lỗi khi xóa CV');
        });
        }
    });
    }
    
    // Xử lý nút xóa học vấn, kinh nghiệm và thành tựu
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        if (!confirm('Bạn có chắc chắn muốn xóa mục này?')) {
          e.preventDefault();
        }
      });
    });
  });
</script>
</body>
</html>